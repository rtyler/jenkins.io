<!DOCTYPE html>
<html>
<head>
<title>
Continuous Delivery of Terraform with Jenkins Pipeline
</title>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="Jenkins is an open source automation server" name="description">
<link href="/sites/default/files/jenkins_favicon.ico" rel="shortcut icon" type="image/x-icon">
<!-- starting partial scriptlinks.html.haml -->
<link href="http://localhost:4242/css/font-awesome.min.css" media="screen" rel="stylesheet">
<link href="http://localhost:4242/assets/bower/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="http://localhost:4242/assets/bower/ekko-lightbox/ekko-lightbox.min.css" media="screen" rel="stylesheet">
<link href="http://localhost:4242/assets/bower/tether/css/tether.min.css" media="screen" rel="stylesheet">
<link href="http://localhost:4242/css/font-icons.css" media="screen" rel="stylesheet">
<link href="http://localhost:4242/css/jenkins.css" media="screen" rel="stylesheet">
<script src="http://localhost:4242/assets/bower/jquery/jquery.min.js"></script>
<script src="http://localhost:4242/assets/bower/tether/js/tether.min.js"></script>
<script src="http://localhost:4242/assets/bower/bootstrap/js/bootstrap.min.js"></script>
<script src="http://localhost:4242/assets/bower/ekko-lightbox/ekko-lightbox.min.js"></script>

<!-- ending partial scriptlinks.html.haml -->
</head>
<body>
<!-- starting partial toptoolbar.html.haml -->
<script>
  $(function () {
    $(document).delegate('*[data-toggle="lightbox"]', 'click', function(event) {
      event.preventDefault();
      $(this).ekkoLightbox();
    });
  })
</script>
<div id="ji-hover-layer"></div>
<div class="ji-toolbar-offset"></div>
<div class="fixed top">
<nav class="navbar navbar-dark bg-inverse" id="ji-toolbar">
<a class="fixed navbar-brand" href="http://localhost:4242" id="home-logo">
Jenkins
</a>
<ul class="nav navbar-nav">
<li class="nav-item fixed">
<div class="btn-group" id="download-menu">
<a aria-expanded="false" aria-haspopup="true" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
Downloads
</a>
<!-- starting partial downloadlist.html.haml -->
<div class="dropdown-menu">
<div class="row">
<div class="col-md-6 text-xs-center">
<h3>
LTS Release
</h3>
<p>
LTS (Long-Term Support) releases are chosen every 12 weeks from the
stream of regular releases as the stable release for that time period.
<a href="https://wiki.jenkins-ci.org/display/JENKINS/LTS+Release+Line">
Learn moreâ€¦
</a>
</p>
</div>
<div class="col-md-6 text-xs-center">
<h3>
Weekly Release
</h3>
<p>
A new release is produced weekly to deliver bug fixes and features to
users and plugin developers.
</p>
</div>
</div>
<div class="row">
<div class="col-md-6 text-xs-center">
<div class="btn-group">
<a class="btn btn-primary chromeOnly" href="http://mirrors.jenkins.io/war-stable/latest/jenkins.war">
<i class="icon-box-add"></i>
2.32.1
.war
</a>
<button aria-expanded="false" aria-haspopup="true" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" data-trigger="hover"></button>
<div class="dropdown-menu">
<a class="dropdown-item" href="https://registry.hub.docker.com/_/jenkins/">
<span class="icon"></span>
<span class="title">
Docker
</span>
</a>
<a class="dropdown-item" href="http://www.freshports.org/devel/jenkins-lts">
<span class="icon"></span>
<span class="title">
FreeBSD
</span>
</a>
<a class="dropdown-item" href="https://packages.gentoo.org/packages/dev-util/jenkins-bin">
<span class="icon"></span>
<span class="title">
Gentoo
</span>
</a>
<a class="dropdown-item" href="/content/thank-you-downloading-os-x-installer#stable">
<span class="icon"></span>
<span class="title">
Mac OS X
</span>
</a>
<a class="dropdown-item" href="http://openports.se/devel/jenkins/stable">
<span class="icon"></span>
<span class="title">
OpenBSD
</span>
</a>
<a class="dropdown-item" href="https://pkg.jenkins.io/opensuse-stable/">
<span class="icon"></span>
<span class="title">
openSUSE
</span>
</a>
<a class="dropdown-item" href="https://pkg.jenkins.io/redhat-stable/">
<span class="icon"></span>
<span class="title">
Red Hat/Fedora/CentOS
</span>
</a>
<a class="dropdown-item" href="https://pkg.jenkins.io/debian-stable/">
<span class="icon"></span>
<span class="title">
Ubuntu/Debian
</span>
</a>
<a class="dropdown-item" href="/content/thank-you-downloading-windows-installer#stable">
<span class="icon"></span>
<span class="title">
Windows
</span>
</a>
</div>
</div>
<p class="details">
<a class="item" href="/changelog-stable">Changelog</a>
|
<a class="item" href="/doc/upgrade-guide">Upgrade Guide</a>
|
<a class="item" href="http://mirrors.jenkins.io/war-stable/">Past Releases</a>
</p>
</div>
<div class="col-md-6 text-xs-center">
<div class="btn-group">
<a class="btn btn-primary chromeOnly" href="http://mirrors.jenkins.io/war/latest/jenkins.war">
<i class="icon-box-add"></i>
2.38
.war
</a>
<button aria-expanded="false" aria-haspopup="true" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" data-trigger="hover"></button>
<div class="dropdown-menu">
<a class="dropdown-item" href="https://registry.hub.docker.com/u/jenkinsci/jenkins/">
<span class="icon"></span>
<span class="title">
Docker
</span>
</a>
<a class="dropdown-item" href="http://www.freshports.org/devel/jenkins">
<span class="icon"></span>
<span class="title">
FreeBSD
</span>
</a>
<a class="dropdown-item" href="https://packages.gentoo.org/packages/dev-util/jenkins-bin">
<span class="icon"></span>
<span class="title">
Gentoo
</span>
</a>
<a class="dropdown-item" href="/content/thank-you-downloading-os-x-installer">
<span class="icon"></span>
<span class="title">
Mac OS X
</span>
</a>
<a class="dropdown-item" href="http://openports.se/devel/jenkins/devel">
<span class="icon"></span>
<span class="title">
OpenBSD
</span>
</a>
<a class="dropdown-item" href="https://pkg.jenkins.io/opensuse/">
<span class="icon"></span>
<span class="title">
openSUSE
</span>
</a>
<a class="dropdown-item" href="https://pkg.jenkins.io/redhat/">
<span class="icon"></span>
<span class="title">
Red Hat/Fedora/CentOS
</span>
</a>
<a class="dropdown-item" href="https://pkg.jenkins.io/debian/">
<span class="icon"></span>
<span class="title">
Ubuntu/Debian
</span>
</a>
<a class="dropdown-item" href="/content/thank-you-downloading-windows-installer">
<span class="icon"></span>
<span class="title">
Windows
</span>
</a>
</div>
</div>
<p class="details">
<a class="item" href="/changelog">Changelog</a>
|
<a class="item" href="http://mirrors.jenkins.io/war/">Past Releases</a>
</p>
</div>
</div>
</div>

<!-- ending partial downloadlist.html.haml -->
</div>
</li>
<li class="nav-item">
<a class="nav-link" href="http://localhost:4242/node">
Blog
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="http://localhost:4242/doc">
Documentation
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="https://plugins.jenkins.io/">
Plugins
</a>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">
Use-cases
</a>
<div class="dropdown-menu">
<a class="dropdown-item feature" href="http://localhost:4242/solutions/android">
Android
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/c">
C/C++
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/docker">
Docker
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/embedded">
Embedded
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/github">
GitHub
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/java">
Java
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/pipeline">
Continuous Delivery
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/python">
Python
</a>
<a class="dropdown-item feature" href="http://localhost:4242/solutions/ruby">
Ruby
</a>
</div>
</li>
<li class="nav-item">
<a class="nav-link" href="http://localhost:4242/participate">
Participate
</a>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="/projects" role="button">
Sub-projects
</a>
<div class="dropdown-menu">
<a class="dropdown-item feature" href="http://localhost:4242/projects/">
Overview
</a>
<a class="dropdown-item feature" href="/projects/blueocean/">
Blue Ocean
</a>
<a class="dropdown-item feature" href="/projects/gsoc/">
Google Summer of Code
</a>
<a class="dropdown-item feature" href="/projects/infrastructure/">
Infrastructure
</a>
<a class="dropdown-item feature" href="/projects/jam/">
Jenkins Area Meetups
</a>
</div>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">
Resources
</a>
<div class="dropdown-menu">
<a class="dropdown-item feature" href="https://accounts.jenkins.io/" title="Create/manage your account for accessing wiki, issue tracker, etc">
Account Management
</a>
<a class="dropdown-item" href="http://localhost:4242/content/chat" title="Chat with the rest of the Jenkins community on IRC">
Chat
</a>
<a class="dropdown-item feature" href="https://issues.jenkins-ci.org/">
Issue Tracker
</a>
<a class="dropdown-item" href="http://localhost:4242/content/mailing-lists" title="Browse Jenkins mailing list archives and/or subscribe to lists">
Mailing Lists
</a>
<a class="dropdown-item feature" href="https://wiki.jenkins-ci.org/">
Wiki
</a>
</div>
</li>
<li class="nav-item">
<a class="nav-link" href="http://localhost:4242/security">
Security
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="http://localhost:4242/press">
Press
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="http://localhost:4242/conduct">
Conduct
</a>
</li>
</ul>
</nav>
</div>
<div id="ji-top-peg">
<a href="https://github.com/jenkinsci" id="ji-fork-tag">
<img alt="Fork us on GitHub" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" style="position: absolute; top: 0; right: 0; border: 0;">
</a>
</div>

<!-- ending partial toptoolbar.html.haml -->
<div class="container blog-post no-margin">
<div class="row body">
<div class="col-md-11 col-md-offset-1 main-content" id="content">
<div id="content-top">
<h1>
<a href="/blog/2017/01/13/pipelining-with-terraform/" title="Continuous Delivery of Terraform with Jenkins Pipeline">
Continuous Delivery of Terraform with Jenkins Pipeline
</a>
</h1>
<!-- starting partial tweetbutton.html.haml -->
<div style="float: right; clear: all;">
<a class="twitter-share-button" data-lang="en" href="https://twitter.com/share">
Tweet
</a>
</div>

<!-- ending partial tweetbutton.html.haml -->
<span class="submitted">
Published on
2017-01-13
by

</span>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a guest post by <a href="https;//github.com/rtyler">R. Tyler Croy</a>, who is a
long-time contributor to Jenkins and the primary contact for Jenkins project
infrastructure. He is also a Jenkins Evangelist at
<a href="http://cloudbees.com">CloudBees, Inc.</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Last year the Jenkins project embarked on a major infrastructure initiative,
thanks to our
<a href="/blog/2016/05/18/announcing-azure-partnership/">partnership with Microsoft</a>,
we have been rethinking our architecture to take advantage of the vast array of
available
<a href="https://www.azure.com">Azure</a>
resources and services. A key ingredient in the effort has been
<a href="http://terraform.io">Terraform</a>
(decision and design can be reviewed
<a href="https://github.com/jenkins-infra/iep/tree/master/iep-003">here</a>).
Terraform allows us to describe our entire infrastructure as <strong>code</strong>, something
we haven&#8217;t previously been able to accomplish. Naturally, when we have any kind
of code, we should have a
<a href="/doc/book/pipeline">Jenkins Pipeline</a>
to ensure we are delivering high quality code to production. In this post, I
would like to share our <code>Jenkinsfile</code> and approach for delivering
infrastructure with Terraform.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/post-images/terraform-pipeline/tf-stage-view.png" alt="Pipeline Stage View with Terraform">
</div>
</div>
<div class="paragraph">
<p>For those unfamiliar with Jenkins Pipeline,
<a href="/doc/book/pipeline">this chapter in the handbook</a>
can explain Pipeline in detail, but in short:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Jenkins Pipeline is a suite of plugins which supports
implementing and integrating continuous delivery pipelines into Jenkins.
Pipeline provides an extensible set of tools for modeling simple-to-complex
delivery pipelines "as code" via the Pipeline DSL.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In discussion with my colleague,
<a href="https://github.com/olblak">Olivier Vernin</a>,
we determined the high-level requirements for our Pipeline were:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The same version of Terraform should be running for all Pipeline runs, as
well as in our local development environments.</p>
</li>
<li>
<p>Pull requests containing new Terraform code must be validated.</p>
</li>
<li>
<p>Ephemeral, or temporary, infrastructure must be destroyed before the Pipeline
exits.</p>
</li>
<li>
<p>Production changes should be reviewed before being deployed ("applied" in
Terraform terminology)</p>
</li>
<li>
<p>Jenkins should be the only "thing" which deploys code to our production environment.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The full <code>Jenkinsfile</code> is open-source and can be found
<a href="https://github.com/jenkins-infra/azure/tree/master/Jenkinsfile">here</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="consistent-terraform-versions"><a class="anchor" href="#consistent-terraform-versions"></a>Consistent Terraform versions</h3>
<div class="paragraph">
<p>While not necessarily Jenkins-specific, consistent versions of tools in
continuous delivery is an important, but often overlooked, part of the process.
Instead of downloading Terraform releases during the Pipeline, or using Tool
Installers, we opted instead for using the Terraform Docker image which is
maintained by Hashicorp.</p>
</div>
<div class="paragraph">
<p>Using Docker for running command-line tools is not very common, I attribute my
learning of it to
<a href="https://github.com/jessfraz">Jessie Frazzellie</a></p>
</div>
<div class="paragraph">
<p>who presented the idea at DockerCon. Using the wrapper script, which can be
found
<a href="https://github.com/jenkins-infra/azure/tree/master/scripts/terraform">here</a>
allows specifying a specific <em>tag</em> which ensures that both developers and
Jenkins are using the same version of Terraform throughout the development
process.</p>
</div>
</div>
<div class="sect2">
<h3 id="pull-request-validation"><a class="anchor" href="#pull-request-validation"></a>Pull Request Validation</h3>

</div>
<div class="sect2">
<h3 id="destroying-ephemeral-resources"><a class="anchor" href="#destroying-ephemeral-resources"></a>Destroying Ephemeral Resources</h3>

</div>
<div class="sect2">
<h3 id="reviewing-production-changes"><a class="anchor" href="#reviewing-production-changes"></a>Reviewing Production Changes</h3>

</div>
<div class="sect2">
<h3 id="deploying-production-from-jenkins"><a class="anchor" href="#deploying-production-from-jenkins"></a>Deploying Production from Jenkins</h3>

</div>
</div>
</div>
</div>


<footer id="footer">
<div class="container">
<div class="row">
<div class="links col-lg-8 col-md-12 col-sm-12">
<ul class="major-areas">
<li class="area solo col-md-3 col-sm-6 col-xs-6">
<div class="div-mar">
<h5>Resources</h5>
<ul class="resources">
<li>
<a href="/content/event-calendar">
Events
</a>
</li>
<li>
<a href="/doc">
Documentation
</a>
</li>
<li>
<a href="/node">
Blog
</a>
</li>
</ul>
</div>
</li>
<li class="area multi col-md-3 col-sm-6 col-xs-6">
<div class="div-mar">
<h5>Solutions</h5>
<ul>
<li>
<a href="/solutions/android">
Android
</a>
</li>
<li>
<a href="/solutions/c">
C/C++
</a>
</li>
<li>
<a href="/solutions/docker">
Docker
</a>
</li>
<li>
<a href="/solutions/embedded">
Embedded
</a>
</li>
<li>
<a href="/solutions/github">
GitHub
</a>
</li>
<li>
<a href="/solutions/java">
Java
</a>
</li>
<li>
<a href="/solutions/pipeline">
Continuous Delivery
</a>
</li>
<li>
<a href="/solutions/python">
Python
</a>
</li>
<li>
<a href="/solutions/ruby">
Ruby
</a>
</li>
</ul>
</div>
</li>
<li class="area multi col-md-3 col-sm-6 col-xs-6">
<div class="div-mar">
<h5>Project</h5>
<ul class="project">
<li>
<a href="https://issues.jenkins-ci.org">
Issue tracker
</a>
</li>
<li>
<a href="https://wiki.jenkins-ci.org">
Wiki
</a>
</li>
<li>
<a href="https://github.com/jenkinsci">
GitHub
</a>
</li>
<li>
<a href="https://ci.jenkins.io">
Jenkins on Jenkins
</a>
</li>
</ul>
</div>
</li>
<li class="area multi col-md-3 col-sm-6 col-xs-6">
<div class="div-mar">
<h5>Community</h5>
<ul class="community">
<li>
<a href="https://groups.google.com/forum/#!forum/jenkinsci-users">
Users mailing list
</a>
</li>
<li>
<a href="https://groups.google.com/forum/#!forum/jenkinsci-dev">
Developers mailing list
</a>
</li>
<li>
<a href="https://twitter.com/jenkinsci">
Twitter
</a>
</li>
<li>
<a href="https://reddit.com/r/jenkinsci">
Reddit
</a>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 footer-left">
<p class="box">
<a href="https://github.com/jenkins-infra/jenkins.io/edit/master/content//blog/2017/2017-01-13-pipelining-with-terraform.adoc" title="Edit /blog/2017/2017-01-13-pipelining-with-terraform.adoc on GitHub">
Improve this page
</a>
|
<a href="https://github.com/jenkins-infra/jenkins.io/commits/master/content//blog/2017/2017-01-13-pipelining-with-terraform.adoc" title="View /blog/2017/2017-01-13-pipelining-with-terraform.adoc history on GitHub">
Page history
</a>
</p>
<div class="license-box">
<div id="creativecommons">
<a href="https://creativecommons.org/licenses/by-sa/4.0/">
<p>
<img src="https://licensebuttons.net/l/by-sa/4.0/88x31.png">
</p>
</a>
<p>
The content driving this site is licensed under the Creative Commons Attribution-ShareAlike 4.0 license.
</p>
</div>
</div>
</div>
</div>
</div>
</footer>
<!-- starting partial footer.html.haml -->
<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-4216293-5', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);

</script>

<script>
  !function(d,s,id) {
    var js, fjs=d.getElementsByTagName(s)[0];
    if (!d.getElementById(id)) {
      js = d.createElement(s);
      js.id=id;
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    }
  }(document,"script","twitter-wjs");
</script>

<!-- ending partial footer.html.haml -->
</body>
</html>
